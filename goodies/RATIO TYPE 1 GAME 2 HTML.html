<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Advanced Ratio Expression Game — Corrected Variant Tokens</title>
<style>
  :root{--bg:#fff;--card:#fff;--muted:#666;--accent:#0b59c6}
  html,body{height:100%;margin:0;background:var(--bg);font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#111}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{width:100%;max-width:1020px;background:var(--card);border-radius:10px;padding:22px 20px;box-shadow:0 8px 28px rgba(16,49,90,0.06)}
  h1{font-size:16px;margin:0 0 10px;font-weight:700}
  .question{font-size:20px;color:var(--accent);margin:12px 0;font-weight:700}
  .prompt{color:var(--muted);font-size:13px;margin-bottom:10px;font-style:italic}
  .steps{white-space:pre-line;font-size:17px;line-height:1.45;color:#111;margin-top:12px}
  .foot{margin-top:10px;color:var(--muted);font-size:13px}
  .hidden{display:none}
  .goodbye{padding:48px;text-align:center;font-size:20px;color:#333}
</style>
</head>
<body>
<div class="wrap">
  <div class="card" id="card" role="main" aria-live="polite">
    <h1>Ratio Expression Evaluation</h1>
    <div class="question" id="qText">—</div>
    <div class="prompt" id="prompt">Press any key to reveal all steps…</div>
    <div id="stepsBox" class="steps hidden"></div>
    <div class="foot">After reveal press <strong>y</strong> for next or <strong>n</strong> to exit.</div>
  </div>
</div>

<script>
(function(){

  // Random integer 1–9
  function rp(){ return Math.floor(Math.random()*9)+1; }

  // Random coefficient ±1..±9 (no zero)
  function rc(){
    var n = Math.floor(Math.random()*9)+1;
    return Math.random()<0.5 ? n : -n;
  }

  // gcd
  function gcd(x,y){
    x=Math.abs(x); y=Math.abs(y);
    while(y!==0){ var t=x%y; x=y; y=t; }
    return x;
  }

  // Format term for expressions
  function formatTerm(coef, variable, isFirst){
    if(coef === 0) return "";
    var absC = Math.abs(coef);
    if(isFirst){
      return (coef < 0 ? "-" : "") + absC + variable;
    }
    return (coef < 0 ? " - " : " + ") + absC + variable;
  }

  // Format complete expression px + qy
  function formatExpr(p,q){
    return formatTerm(p,"x",true) + formatTerm(q,"y",false);
  }

  // Question language variants using safe tokens {A} {B} {TOP} {BOT}
  var variants = [
    "If x : y = {A} : {B}, find the ratio ({TOP}) : ({BOT}).",
    "Given that x : y = {A} : {B}, determine the value of the ratio ({TOP}) to ({BOT}).",
    "Based on the ratio x : y = {A} : {B}, compute the ratio ({TOP}) and ({BOT}).",
    "If the numbers x and y stand in the ratio {A} : {B}, what will be the ratio of the expressions ({TOP}) and ({BOT})?",
    "Using the fact that x : y = {A} : {B}, evaluate the ratio formed by ({TOP}) to ({BOT})."
  ];

  var stage="question";
  var A,B,P,Q,R,S;
  var qEl=document.getElementById("qText");
  var prompt=document.getElementById("prompt");
  var stepsBox=document.getElementById("stepsBox");

  function makeQuestion(){

    stage="question";
    stepsBox.classList.add("hidden");
    stepsBox.textContent="";
    prompt.textContent="Press any key to reveal all steps…";

    // Regeneration loop to satisfy final-positivity rules
    while(true){
      A=rp();
      B=rp();
      P=rc();
      Q=rc();
      R=rc();
      S=rc();

      // compute numerator and denominator BEFORE acceptance
      var num = P*A + Q*B;
      var den = R*A + S*B;

      // reject zero numerator or denominator
      if(num === 0 || den === 0) continue;

      // accept only if both positive OR both negative (both negative will be flipped later)
      if((num > 0 && den > 0) || (num < 0 && den < 0)) break;
      // else mixed signs => regenerate
    }

    // Build expressions for the question (no double signs)
    var topExpr = formatExpr(P,Q);
    var botExpr = formatExpr(R,S);

    // Pick question variant and safely replace tokens globally
    var v = variants[Math.floor(Math.random()*variants.length)];
    var q = v.replace(/\{A\}/g, A)
             .replace(/\{B\}/g, B)
             .replace(/\{TOP\}/g, topExpr)
             .replace(/\{BOT\}/g, botExpr);

    qEl.textContent = q;
  }

  function reveal(){
    stage="answer";
    prompt.textContent='Press "y" for next or "n" to exit.';
    stepsBox.classList.remove("hidden");

    var pA = P*A, qB = Q*B;
    var rA = R*A, sB = S*B;

    var num = pA + qB;
    var den = rA + sB;

    // If both negative → flip to positive, otherwise we've already ensured mixed signs don't occur
    if(num < 0 && den < 0){
      num = -num;
      den = -den;
    }

    // gcd simplify
    var g = gcd(num, den);
    var simpNum = num/g;
    var simpDen = den/g;

    // good formatting
    var topExpr = formatExpr(P,Q);
    var botExpr = formatExpr(R,S);

    var t = "";

    t += "Step 1 — Let the two numbers be:\n";
    t += "x = " + A + "k,   y = " + B + "k\n\n";

    t += "Step 2 — Substitute x & y in the ratio:\n";
    t += "(" + topExpr + ") / (" + botExpr + ")\n";
    t += "⇒  " + P + "(" + A + "k) + " + Q + "(" + B + "k)\n";
    t += "    " + R + "(" + A + "k) + " + S + "(" + B + "k)\n\n";

    t += "Step 3 — Compute each part:\n";
    t += P + "(" + A + "k) = " + pA + "k\n";
    t += Q + "(" + B + "k) = " + qB + "k\n";
    t += R + "(" + A + "k) = " + rA + "k\n";
    t += S + "(" + B + "k) = " + sB + "k\n\n";

    t += "Step 4 — Add like terms:\n";
    t += "Numerator: " + pA + "k + " + qB + "k = " + (pA+qB) + "k\n";
    t += "Denominator: " + rA + "k + " + sB + "k = " + (rA+sB) + "k\n\n";

    t += "Step 5 — Cancel the common factor k:\n";
    t += (pA+qB) + "k / " + (rA+sB) + "k = " + (pA+qB) + " / " + (rA+sB) + "\n\n";

    t += "Step 6 — Simplify the fraction if possible:\n";
    if(g > 1){
      t += (pA+qB) + "/" + (rA+sB) + " = " + simpNum + "/" + simpDen + "\n\n";
    } else {
      t += "Already in simplest form.\n\n";
    }

    t += "Step 7 — Final ratio:\n";
    t += simpNum + " : " + simpDen;

    stepsBox.textContent = t;
  }

  makeQuestion();

  window.addEventListener("keydown",function(e){
    var k=(e.key||"").toLowerCase();
    if(stage==="question"){
      reveal();
    } else if(stage==="answer"){
      if(k==="y"){
        makeQuestion();
      } else if(k==="n"){
        document.getElementById("card").innerHTML =
          '<div class="goodbye">Goodbye — thanks!<div style="font-size:13px;color:#666;margin-top:8px">You may now close this tab.</div></div>';
      }
    }
  });

  document.addEventListener("selectstart",function(e){ e.preventDefault(); });
})();
</script>
</body>
</html>
